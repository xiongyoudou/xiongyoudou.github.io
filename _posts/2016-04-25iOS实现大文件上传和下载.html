---
title: "实现大文件上传和下载"
categories:
  - Essays
tags:
  - essay
  - space
excerpt: "利用NSURLSession来进行大文件的上传和下载"
---
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.8 (453749)"/><meta name="author" content="xiongyoudou@qq.com"/><meta name="created" content="2016-08-22 01:25:38 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-08-22 01:25:54 +0000"/><title>iOS实现大文件上传和下载</title></head><body>
<div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<p style="box-sizing: border-box; outline: none !important;">iOS7之后，系统引入了<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSession</strong>类，用以替代陈旧的<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLConnection</strong>的类，它是包含一套处理<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">HTTP/HTTPS-based</strong>请求的类。</p>
</div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<p style="box-sizing: border-box; outline: none !important;"><br style="box-sizing: border-box; outline: none !important;"/>
<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSession</strong>是负责发送和接收HTTP请求的主体，其他关键的类还包括：</p>
<ol style="box-sizing: border-box; outline: none !important;">
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSessionConfiguration</strong>：创建一个处理cache、cookie、凭证等属性的配置对象</li>
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSessionTask</strong>：iOS中<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">任务</code>的抽象表示，session创建一个<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">任务</code>之后，该<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">任务</code>对象才真正处理<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">文件上传</code>和<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">文件下载</code>的工作。该抽象类包括三个具体的子类： <br style="box-sizing: border-box; outline: none !important;"/>
<ul style="box-sizing: border-box; outline: none !important;">
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSessionDataTask</strong>：通过<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">HTTP</strong>的<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">GET</strong>方式从服务器获取数据</li>
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSessionUploadTask</strong>：上传文件至服务器，主要通过<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">HTTP</strong>的<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">POST</strong>或者<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">PUT</strong>方式</li>
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">NSURLSessionDownloadTask</strong>：从服务器下载文件</li>
</ul>
</li>
</ol>
</div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<p style="box-sizing: border-box; outline: none !important;"> <br style="box-sizing: border-box; outline: none !important;"/>
任务能够执行暂停、继续以及取消等操作。</p>
</div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<h3 style="box-sizing: border-box; outline: none !important; font-family: inherit; font-weight: bold; color: inherit; font-size: 1.7em; text-align: start;">大文件下载</h3>
<p style="box-sizing: border-box; outline: none !important;">可利用系统框架提供的专门下载的NSURLSessionDownloadTask来进行文件下载：</p>
</div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<pre style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; white-space: pre-wrap; padding: 0px; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 0px; border-radius: 5px; text-align: start; background: rgb(246, 246, 246);">
<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: inherit; padding: 0.5em; color: rgb(248, 248, 242); white-space: pre-wrap; border-radius: 0px; background: rgb(35, 36, 31);">    - (<span style="box-sizing: border-box; outline: none !important; color: rgb(230, 219, 116);">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:<br style="box-sizing: border-box; outline: none !important;"/>                                             progress:<br style="box-sizing: border-box; outline: none !important;"/>                                          destination:<br style="box-sizing: border-box; outline: none !important;"/>                                    completionHandler:<br style="box-sizing: border-box; outline: none !important;"/></code>
</pre>
<p style="box-sizing: border-box; outline: none !important;">API中只需要提供下载地址，并可以处理下载进度以及下载完成之后的操作。 <br style="box-sizing: border-box; outline: none !important;"/>
另外文件过大时，最好能提供断点续传功能，否则一旦出错，整个文件的下载都需要从头开始。支持断点续传很简单，只需在HTTP中加入<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">Range</code>信息，便能从指定位置开始下载。但是API中并不需要你明确的指定<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">Range</code>，而是指定<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">ResumeData</code>，此信息在用户暂停时通过调用系统API得到，之后保存在本地。如果要实现下次继续下载，则从本地取出调用下面API即可。</p>
</div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<pre style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; white-space: pre-wrap; padding: 0px; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 0px; border-radius: 5px; text-align: start; background: rgb(246, 246, 246);">
<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: inherit; padding: 0.5em; color: rgb(248, 248, 242); white-space: pre-wrap; border-radius: 0px; background: rgb(35, 36, 31);">    - (<span style="box-sizing: border-box; outline: none !important; color: rgb(230, 219, 116);">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:<br style="box-sizing: border-box; outline: none !important;"/>                                             progress:<br style="box-sizing: border-box; outline: none !important;"/>                                          destination:<br style="box-sizing: border-box; outline: none !important;"/>                                    completionHandler:<br style="box-sizing: border-box; outline: none !important;"/></code>
</pre>
<blockquote style="box-sizing: border-box; outline: none !important; padding: 15px 20px; border-left-width: 10px; border-left-style: solid; border-left-color: rgba(102, 128, 153, 0.0745098); border-top-right-radius: 5px; border-bottom-right-radius: 5px; background-color: rgba(102, 128, 153, 0.0470588);">
<p style="box-sizing: border-box; outline: none !important; font-size: 1em; font-weight: 300;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">注意</strong>：<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">ResumeData</code>是通过plist属性文件的形式存储在沙盒中，经过验证发现iOS8与iOS9中存储的键值有差异，如果需要验证<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">ResumeData</code>文件的有效性，需要考虑到这一点。</p>
</blockquote>
</div>
<div style="box-sizing: border-box; outline: none !important; color: rgb(44, 63, 81); font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<h3 style="box-sizing: border-box; outline: none !important; font-family: inherit; font-weight: bold; color: inherit; font-size: 1.7em; text-align: start;">大文件上传</h3>
<p style="box-sizing: border-box; outline: none !important;">初期考虑大文件上传有两种解决方案：</p>
<ol style="box-sizing: border-box; outline: none !important;">
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">文件流</strong>的形式，利用<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">Stream</code>或者<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">socket</code>，较底层一点，技术难度稍大一些</li>
<li style="box-sizing: border-box; outline: none !important;"><strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">HTTP</strong>形式，实现简单，但是处理断点续传需要考虑文件分块问题 <br style="box-sizing: border-box; outline: none !important;"/>
在客户端，可以支持多文件同时传输，因此程序中有<strong style="box-sizing: border-box; outline: none !important; font-weight: bold;">队列</strong>进行控制，可以同时有多个文件的分块在并发传输。 <br style="box-sizing: border-box; outline: none !important;"/>
项目中现在分块大小为<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">4M</code>,一个大文件的分块是按顺序进行传输的，每一个分块都会标记<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">这是第几块</code>，只有当某个分块完了，其后面的下一个分块才开始传输；如果程序暂停，那么会记录下来当前上传成功的<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">块序号</code>，下一次继续上传时，则只上传该<code style="box-sizing: border-box; outline: none !important; font-family: 'Source Code Pro', monospace; font-size: 0.9em; padding: 2px 4px; color: rgb(199, 37, 78); white-space: normal; border-radius: 4px; background-color: rgb(249, 242, 244);">块序号</code>后面的文件分块。当所有分块上传完毕后，服务器会合并所有分块成为一个完整文件，同时客户端处理上传完成的callback。</li>
</ol>
</div>
</div>
</body></html>